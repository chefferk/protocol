<!DOCTYPE html>
<html>

    <head>
        <!-- USE DEVELOPMENT VERSION -->
        <script src="https://unpkg.com/konva@3.2.4/konva.min.js"></script>
        <meta charset="utf-8" />
        <title>Konva Transform Events Demo</title>
        <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f0f0;
      }
    </style>
    </head>

    <body>
        <button id="toggle">Toggle hit canvas</button>
        <button id="add32">Add 32 min</button>
        <button id="add143">Add 143 min</button>
        <button id="add610">Add 610 min</button>
        <button id="add943">Add 943 min</button>
        <button id="add74">Add 74 min</button>
        <button id="add72">Add 72 min</button>
        <div id="container"></div>
        <script>
      var width = window.innerWidth;
      var height = window.innerHeight;

      var stage = new Konva.Stage({
        container: 'container',
        width: width,
        height: height
      });

      var layer = new Konva.Layer();
      stage.add(layer);

      var threshold = {{ threshold }};


      if (143 > threshold) {
        document.getElementById("add143").disabled = true;
      }

      if (32 > threshold) {
        document.getElementById("add32").disabled = true;
      }

      if (610 > threshold) {
        document.getElementById("add610").disabled = true;
      }

      if (943 > threshold) {
        document.getElementById("add943").disabled = true;
      }

      if (74 > threshold) {
        document.getElementById("add74").disabled = true;
      }

      if (72 > threshold) {
        document.getElementById("add72").disabled = true;
      }

      // ---------- grid (143 min) ---------- //
      document.getElementById('add143').addEventListener('click', function () {
        updateAvaliable()
        console.log('add 143')
        layer.add(new Konva.Rect({
            x: 160,
            y: 160,
            width: 90.7, // 24 mm
            height: 90.7, // 24 mm
            fill: 'yellow',
            name: 'rect',
            draggable: true,
            value: 143
        }));
        updateCount();
        updateAvaliable()
      });

      // ---------- 1 line (32 min) ---------- //
      document.getElementById('add32').addEventListener('click', function () {
        updateAvaliable()
        console.log('add 32')
        layer.add(new Konva.Rect({
            x: 360,
            y: 160,
            width: 4.8,
            height: 90.7,
            fill: 'yellow',
            name: 'rect',
            draggable: true,
            value: 32,
            hitFunc: function (context) {
                context.beginPath();
                context.rect(-15, -10, 4.8 + 30, 90.7 + 20);
                context.closePath();
                context.fillStrokeShape(this);
                }
        }));
        updateCount();
        updateAvaliable()
      });

      // ---------- 7x7 square (610 min) ---------- //
      document.getElementById('add610').addEventListener('click', function () {
        updateAvaliable()
        console.log('add 610')
        layer.add(new Konva.Rect({
            x: 560,
            y: 160,
            width: 26.3,
            height: 26.3,
            fill: 'yellow',
            name: 'rect',
            draggable: true,
            value: 610,
            hitFunc: function (context) {
            context.beginPath();
            context.rect(-10, -10, 26.3 + 20, 26.3 + 20);
            context.closePath();
            context.fillStrokeShape(this);
            }
        }));
        updateCount();
        updateAvaliable()

      });

      // ---------- 5x15 square (943 min) ---------- //
      document.getElementById('add943').addEventListener('click', function () {
        updateAvaliable()
        console.log('add 943')
        layer.add(new Konva.Rect({
            x: 760,
            y: 160,
            width: 19.0,
            height: 56.7,
            fill: 'yellow',
            name: 'rect',
            draggable: true,
            value: 943,
            hitFunc: function (context) {
            context.beginPath();
            context.rect(-10, -10, 19.0 + 20, 56.7 + 20);
            context.closePath();
            context.fillStrokeShape(this);
            }
        }));
        updateCount();
        updateAvaliable()
      });

      // ---------- 2x2 square (72 min) ---------- //
      document.getElementById('add72').addEventListener('click', function () {
        updateAvaliable()
        console.log('add 72')
        layer.add(new Konva.Rect({
            x: 960,
            y: 160,
            width: 8.2,
            height: 8.2,
            fill: 'yellow',
            name: 'rect',
            draggable: true,
            value: 72,
            hitFunc: function (context) {
            context.beginPath();
            context.arc(5, 5, 25, 0, Math.PI * 2, true);
            context.closePath();
            context.fillStrokeShape(this);
            }
        }));
        updateCount();
        updateAvaliable()
    });

      // ---------- 3 lines (74 min) ---------- //
      document.getElementById('add74').addEventListener('click', function () {
        updateAvaliable()
        console.log('add 74')
        layer.add(
            new Konva.Rect({
                x: 1160,
                y: 160,
                width: 56.7,
                height: 90.7,
                fill: 'yellow',
                name: 'rect',
                draggable: true,
                value: 74
          }));
        layer.draw()
        updateCount();
        updateAvaliable()
      });

      // ---------- layer settings ---------- //
      layer.on('mouseenter', function () {
        stage.container().style.cursor = 'pointer';
      });

      layer.on('mouseleave', function () {
        stage.container().style.cursor = 'default';
      });

      layer.on('dblclick dbltap', function (e) {
        updateAvaliable()
        stage.find('Transformer').destroy()
        e.target.remove();
        layer.draw();
        updateCount(e.target);
        updateAvaliable()
      });

      stage.on('click tap', function (e) {
        // if click on empty area - remove all transformers
        if (e.target === stage) {
          stage.find('Transformer').destroy();
          layer.draw();
          return;
        }
        // do nothing if clicked NOT on our rectangles
        if (!e.target.hasName('rect')) {
          return;
        }
        // remove old transformers
        // TODO: we can skip it if current rect is already selected
        stage.find('Transformer').destroy();

        // create new transformer
        var tr = new Konva.Transformer({
          rotationSnaps: [0, 90, 180, 270],
          resizeEnabled: false
        });
        layer.add(tr);
        tr.attachTo(e.target);
        layer.draw();
      });

      var countText = new Konva.Text({
        x: 1105,
        y: 5
      });

      layer.add(countText);

      function getCount() {
        var i = 0;
        count = 0;
        for (i = 0; i < layer.children.length; i++) {
          if (layer.children[i].attrs.value) {
            count += layer.children[i].attrs.value
          }
        }
        return count;
      }

      function updateAvaliable() {
        // 143
        if (getCount() + 143 > threshold) {
          document.getElementById("add143").disabled = true;
        } else {
          document.getElementById("add143").disabled = false;
        }

        // 32
        if (getCount() + 32 > threshold) {
          document.getElementById("add32").disabled = true;
        } else {
          document.getElementById("add32").disabled = false;
        }

        // 610
        if (getCount() + 610 > threshold) {
          document.getElementById("add610").disabled = true;
        } else {
          document.getElementById("add610").disabled = false;
        }

        // 943
        if (getCount() + 943 > threshold) {
          document.getElementById("add943").disabled = true;
        } else {
          document.getElementById("add943").disabled = false;
        }

        // 74
        if (getCount() + 74 > threshold) {
          document.getElementById("add74").disabled = true;
        } else {
          document.getElementById("add74").disabled = false;
        }

        // 72
        if (getCount() + 72 > threshold) {
          document.getElementById("add72").disabled = true;
        } else {
          document.getElementById("add72").disabled = false;
        }
      }

      function updateCount() {
        var count = [
          'Total time: ' + getCount(),
        ];
        countText.text(count.join(''));
        layer.batchDraw();
      }

      document.getElementById('toggle').addEventListener('click', function () {
        layer.toggleHitCanvas();
        getCount();
      });

    </script>
    </body>

</html>
