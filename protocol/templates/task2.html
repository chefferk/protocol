{% extends 'layout.html' %} {% block head %}
<script src="https://cdn.rawgit.com/konvajs/konva/2.4.0/konva.min.js"></script>
<script src="https://unpkg.com/konva@3.2.4/konva.min.js"></script>
{% endblock %} {% block body_no %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-4">
            <div class="row">
                <div class="col">
                    <h4>Let's start with a short (max 45 min) series of
                        analyses.</h4>
                    <br />
                    <div class="card">
                        <div class="card-header card-header-primary">
                            <div class="card-text">
                                <h4 class="card-title">Task 2/4</h4>
                            </div>
                        </div>
                        <div class="card-body" align="left">
                            <h4>
                                Step 1:
                            </h4>
                            <p>
                                Select up to <strong>45 min</strong> <br />
                                of PIXL analyses <br />
                                and place them on the image.
                            </p>
                            <h4>
                                Step 2:
                            </h4>
                            <p>
                                Number them by priority <br />
                                (1 = higher priority/relevance) <br />
                                and write notes (below) <br />
                                about their rationale.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <h3 id="timeCount">Total time: 000/{{ threshold }}</h3>
                    <button class="btn btn-default" id="add32">Add 32 min</button>
                    <button class="btn btn-default" id="add143">Add 143 min</button>
                    <button class="btn btn-default" id="add610">Add 610 min</button>
                    <button class="btn btn-default" id="add943">Add 943 min</button>
                    <button class="btn btn-default" id="add74">Add 74 min</button>
                    <button class="btn btn-default" id="add72">Add 72 min</button>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div
                id="container"
                style="background:
                url('https://storage.googleapis.com/geovision-site/Picture3.png');
                width: 100%;"></div>
        </div>
    </div>
    <form action="" method="GET">
        <fieldset class="form-group">
            <input
                type="hidden"
                id="locations"
                name="locations"
                value="NaN"
                />
            <div class="container">
                <!-- proceed button -->
                <!-- {% with page = 'main.highresolution', back='main.outcrop' %}
                {% include 'includes/_proceed_button.html' %}
                {% endwith %} -->
                <input class="btn btn-primary" type="submit" value="Submit"
                    id="locationSubmit">
            </div>
        </fieldset>
    </form>
</div>

<script>
  var width = 1000;
  var height = 1000;

  var stage = new Konva.Stage({
      container: 'container',
      width: width,
      height: height
  });

  var layer = new Konva.Layer();
  stage.add(layer);

  var threshold = {{ threshold }};


  if (143 > threshold) {
      document.getElementById("add143").disabled = true;
  }

  if (32 > threshold) {
      document.getElementById("add32").disabled = true;
  }

  if (610 > threshold) {
      document.getElementById("add610").disabled = true;
  }

  if (943 > threshold) {
      document.getElementById("add943").disabled = true;
  }

  if (74 > threshold) {
      document.getElementById("add74").disabled = true;
  }

  if (72 > threshold) {
      document.getElementById("add72").disabled = true;
  }

  if ( "{{ visited }}"  === "True") {
      console.log('{{ locations }}');
  }


  // ---------- grid (143 min) ---------- //
  document.getElementById('add143').addEventListener('click', function () {
    add143();
  });

  function add143() {
        updateAvaliable()
        console.log('add 143')
        layer.add(new Konva.Rect({
          x: width / 6,
          y: 160,
          width: 90.7, // 24 mm
          height: 90.7, // 24 mm
          fill: 'yellow',
          name: 'rect',
          draggable: true,
          value: 143
      }));
      updateCount();
      updateAvaliable()
  }

  // ---------- 1 line (32 min) ---------- //
  document.getElementById('add32').addEventListener('click', function () {
      add32();
  });

  function add32() {
      updateAvaliable()
      console.log('add 32')
      layer.add(new Konva.Rect({
          x: (width / 6) * 2,
          y: 160,
          width: 4.8,
          height: 90.7,
          fill: 'yellow',
          name: 'rect',
          draggable: true,
          value: 32,
          hitFunc: function (context) {
              context.beginPath();
              context.rect(-15, -10, 4.8 + 30, 90.7 + 20);
              context.closePath();
              context.fillStrokeShape(this);
          }
      }));
      updateCount();
      updateAvaliable()
  }

  // ---------- 7x7 square (610 min) ---------- //
  document.getElementById('add610').addEventListener('click', function () {
      add610();
  });

  function add610() {
      updateAvaliable()
      console.log('add 610')
      layer.add(new Konva.Rect({
          x: (width / 6) * 3,
          y: 160,
          width: 26.3,
          height: 26.3,
          fill: 'yellow',
          name: 'rect',
          draggable: true,
          value: 610,
          hitFunc: function (context) {
              context.beginPath();
              context.rect(-10, -10, 26.3 + 20, 26.3 + 20);
              context.closePath();
              context.fillStrokeShape(this);
          }
      }));
      updateCount();
      updateAvaliable()
  }

  // ---------- 5x15 square (943 min) ---------- //
  document.getElementById('add943').addEventListener('click', function () {
      add943();
  });

  function add943() {
      updateAvaliable()
      console.log('add 943')
      layer.add(new Konva.Rect({
          x: (width / 6),
          y: 360,
          width: 19.0,
          height: 56.7,
          fill: 'yellow',
          name: 'rect',
          draggable: true,
          value: 943,
          hitFunc: function (context) {
              context.beginPath();
              context.rect(-10, -10, 19.0 + 20, 56.7 + 20);
              context.closePath();
              context.fillStrokeShape(this);
          }
      }));
      updateCount();
      updateAvaliable()
  }

  // ---------- 2x2 square (72 min) ---------- //
  document.getElementById('add72').addEventListener('click', function () {
      add72();
  });

  function add72() {
      updateAvaliable()
      console.log('add 72')
      layer.add(new Konva.Rect({
          x: (width / 6) * 2,
          y: 360,
          width: 8.2,
          height: 8.2,
          fill: 'yellow',
          name: 'rect',
          draggable: true,
          value: 72,
          hitFunc: function (context) {
              context.beginPath();
              context.arc(5, 5, 25, 0, Math.PI * 2, true);
              context.closePath();
              context.fillStrokeShape(this);
          }
      }));
      updateCount();
      updateAvaliable()
  }

  // ---------- 3 lines (74 min) ---------- //
  document.getElementById('add74').addEventListener('click', function () {
      add74();
  });

  function add74() {
      updateAvaliable()
      console.log('add 74')
      layer.add(
          new Konva.Rect({
              x: (width / 6) * 3,
              y: 360,
              width: 56.7,
              height: 90.7,
              fill: 'yellow',
              name: 'rect',
              draggable: true,
              value: 74
          }));
      layer.draw()
      updateCount();
      updateAvaliable()
  }

  // ---------- layer settings ---------- //
  layer.on('mouseenter', function () {
      stage.container().style.cursor = 'pointer';
  });

  layer.on('mouseleave', function () {
      stage.container().style.cursor = 'default';
  });

  layer.on('dblclick dbltap', function (e) {
      updateAvaliable()
      stage.find('Transformer').destroy()
      e.target.remove();
      layer.draw();
      updateCount(e.target);
      updateAvaliable()
  });

  stage.on('click tap', function (e) {
      // if click on empty area - remove all transformers
      if (e.target === stage) {
          stage.find('Transformer').destroy();
          layer.draw();
          return;
      }
      // do nothing if clicked NOT on our rectangles
      if (!e.target.hasName('rect')) {
          return;
      }
      // remove old transformers
      // TODO: we can skip it if current rect is already selected
      stage.find('Transformer').destroy();

      // create new transformer
      var tr = new Konva.Transformer({
          rotationSnaps: [0, 90, 180, 270],
          resizeEnabled: false
      });
      layer.add(tr);
      tr.attachTo(e.target);
      layer.draw();
  });

  function getCount() {
      var i = 0;
      count = 0;
      for (i = 0; i < layer.children.length; i++) {
          if (layer.children[i].attrs.value) {
              count += layer.children[i].attrs.value
          }
      }

      return count;
  }

  function updateAvaliable() {
      // 143
      if (getCount() + 143 > threshold) {
          document.getElementById("add143").disabled = true;
      } else {
          document.getElementById("add143").disabled = false;
      }

      // 32
      if (getCount() + 32 > threshold) {
          document.getElementById("add32").disabled = true;
      } else {
          document.getElementById("add32").disabled = false;
      }

      // 610
      if (getCount() + 610 > threshold) {
          document.getElementById("add610").disabled = true;
      } else {
          document.getElementById("add610").disabled = false;
      }

      // 943
      if (getCount() + 943 > threshold) {
          document.getElementById("add943").disabled = true;
      } else {
          document.getElementById("add943").disabled = false;
      }

      // 74
      if (getCount() + 74 > threshold) {
          document.getElementById("add74").disabled = true;
      } else {
          document.getElementById("add74").disabled = false;
      }

      // 72
      if (getCount() + 72 > threshold) {
          document.getElementById("add72").disabled = true;
      } else {
          document.getElementById("add72").disabled = false;
      }
  }

  function padDigits(number, digits) {
      return Array(Math.max(digits - String(number).length + 1, 0)).join(0) + number;
  }

  function updateCount() {
      document.getElementById('timeCount').innerHTML = 'Total time: ' + padDigits(getCount(), 3) + '/{{ threshold }}'
      layer.draw()
  };

  function fitStageIntoParentContainer() {
      var container = document.querySelector('#stage-parent');

      // now we need to fit stage into parent
      var containerWidth = container.offsetWidth;
      // to do this we need to scale the stage
      var scale = containerWidth / stageWidth;

      stage.width(stageWidth * scale);
      stage.height(stageHeight * scale);
      stage.scale({ x: scale, y: scale });
      stage.draw();
  }

  document.getElementById("locationSubmit").addEventListener('click', function() {
      console.log('got here');
      console.log(layer.children);
      document.getElementById('locations').value = JSON.stringify(layer.getChildren())
  });

  fitStageIntoParentContainer();
  // adapt the stage on any window resize
  window.addEventListener('resize', fitStageIntoParentContainer);
</script>


<script src="https://cdn.jsdelivr.net/npm/interactjs@1.3/dist/interact.min.js"></script>
{% endblock %}
