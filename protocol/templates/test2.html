<!DOCTYPE html>
<html>

  <head>
    <!-- USE DEVELOPMENT VERSION -->
    <script src="https://unpkg.com/konva@3.2.4/konva.min.js"></script>
    <meta charset="utf-8" />
    <title>Konva Transform Events Demo</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f0f0;
      }
    </style>
  </head>

  <body>
    <button id="toggle">Toggle hit canvas</button>
    <button id="add32">Add 32 min</button>
    <button id="add143">Add 143 min</button>
    <button id="add610">Add 610 min</button>
    <button id="add943">Add 943 min</button>
    <button id="add74">Add 74 min</button>
    <button id="add72">Add 72 min</button>
    <div id="container"></div>
    <script>
      var width = window.innerWidth;
      var height = window.innerHeight;

      var stage = new Konva.Stage({
        container: 'container',
        width: width,
        height: height
      });

      var layer = new Konva.Layer();
      stage.add(layer);

      var threshold = {{ threshold }};


      if (143 > threshold) {
        document.getElementById("add143").disabled = true;
      }

      if (32 > threshold) {
        document.getElementById("add32").disabled = true;
      }

      if (610 > threshold) {
        document.getElementById("add610").disabled = true;
      }

      if (943 > threshold) {
        document.getElementById("add943").disabled = true;
      }

      if (74 > threshold) {
        document.getElementById("add74").disabled = true;
      }

      if (72 > threshold) {
        document.getElementById("add72").disabled = true;
      }


      // ---------- grid (143 min) ---------- //
      class grid {
        constructor(x, y) {
          var rect = new Konva.Rect({
            x: x,
            y: y,
            width: 90.7, // 24 mm
            height: 90.7, // 24 mm
            fill: 'yellow',
            name: 'rect',
            draggable: true,
            value: 143
          });
        }
      }

      var rect = new Konva.Rect({
        x: 160,
        y: 160,
        width: 90.7, // 24 mm
        height: 90.7, // 24 mm
        fill: 'yellow',
        name: 'rect',
        draggable: true,
        value: 143
      });

      rect.on('transformstart', function () {
        console.log('transform start');
      });

      rect.on('dragmove', function () {
        updateText(rect, text);
      });
      rect.on('transform', function () {
        updateText(rect, text);
        console.log('transform');
      });

      rect.on('transformend', function () {
        console.log('transform end');
      });

      rect.on('dblclick dbltap', function () {
        updateAvaliable()
        rect.remove();
        text.remove();
        layer.draw();
        updateCount(rect);
        updateAvaliable()
      });

      rect.on('mouseenter', function () {
        stage.container().style.cursor = 'pointer';
      });

      rect.on('mouseleave', function () {
        stage.container().style.cursor = 'default';
      });

      var text = new Konva.Text({
        x: 5,
        y: 5
      });

      document.getElementById('add143').addEventListener('click', function () {
        updateAvaliable()
        console.log('add 143')
        layer.add(rect);
        layer.add(text);
        updateText(rect, text);
        updateCount(rect);
        updateAvaliable()
      });

      // ---------- 1 line (32 min) ---------- //
      var rect2 = new Konva.Rect({
        x: 360,
        y: 160,
        width: 4.8,
        height: 90.7,
        fill: 'yellow',
        name: 'rect',
        draggable: true,
        value: 32,
        hitFunc: function (context) {
          context.beginPath();
          context.rect(-15, -10, 4.8 + 30, 90.7 + 20);
          context.closePath();
          context.fillStrokeShape(this);
        }
      });

      rect2.on('transformstart', function () {
        console.log('transform start');
      });

      rect2.on('dragmove', function () {
        updateText(rect2, text2);
      });
      rect2.on('transform', function () {
        updateText(rect2, text2);
        console.log('transform');
      });

      rect2.on('transformend', function () {
        console.log('transform end');
      });

      rect2.on('dblclick dbltap', function () {
        updateAvaliable()
        rect2.remove();
        text2.remove();
        layer.draw();
        updateCount(rect2);
        updateAvaliable()
      });

      rect2.on('mouseenter', function () {
        stage.container().style.cursor = 'pointer';
      });

      rect2.on('mouseleave', function () {
        stage.container().style.cursor = 'default';
      });

      var text2 = new Konva.Text({
        x: 105,
        y: 5
      });

      document.getElementById('add32').addEventListener('click', function () {
        updateAvaliable()
        console.log('add 32')
        layer.add(rect2);
        layer.add(text2);
        updateText(rect2, text2);
        updateCount(rect2);
        updateAvaliable()
      });

      // ---------- 7x7 square (610 min) ---------- //
      var rect3 = new Konva.Rect({
        x: 560,
        y: 160,
        width: 26.3,
        height: 26.3,
        fill: 'yellow',
        name: 'rect',
        draggable: true,
        value: 610,
        hitFunc: function (context) {
          context.beginPath();
          context.rect(-10, -10, 26.3 + 20, 26.3 + 20);
          context.closePath();
          context.fillStrokeShape(this);
        }
      });

      rect3.on('transformstart', function () {
        console.log('transform start');
      });

      rect3.on('dragmove', function () {
        updateText(rect3, text3);
      });
      rect3.on('transform', function () {
        updateText(rect3, text3);
        console.log('transform');
      });

      rect3.on('transformend', function () {
        console.log('transform end');
      });

      rect3.on('dblclick dbltap', function () {
        updateAvaliable()
        rect3.remove();
        text3.remove();
        layer.draw();
        updateCount(rect3);
        updateAvaliable()
      });

      rect3.on('mouseenter', function () {
        stage.container().style.cursor = 'pointer';
      });

      rect3.on('mouseleave', function () {
        stage.container().style.cursor = 'default';
      });

      var text3 = new Konva.Text({
        x: 205,
        y: 5
      });

      document.getElementById('add610').addEventListener('click', function () {
        updateAvaliable()
        console.log('add 610')
        layer.add(rect3);
        layer.add(text3);
        updateText(rect3, text3);
        updateCount(rect3);
        updateAvaliable()

      });

      // ---------- 5x15 square (943 min) ---------- //
      var rect4 = new Konva.Rect({
        x: 760,
        y: 160,
        width: 19.0,
        height: 56.7,
        fill: 'yellow',
        name: 'rect',
        draggable: true,
        value: 943,
        hitFunc: function (context) {
          context.beginPath();
          context.rect(-10, -10, 19.0 + 20, 56.7 + 20);
          context.closePath();
          context.fillStrokeShape(this);
        }
      });

      rect4.on('transformstart', function () {
        console.log('transform start');
      });

      rect4.on('dragmove', function () {
        updateText(rect4, text4);
      });
      rect4.on('transform', function () {
        updateText(rect4, text4);
        console.log('transform');
      });

      rect4.on('transformend', function () {
        console.log('transform end');
      });

      rect4.on('dblclick dbltap', function () {
        updateAvaliable()
        rect4.remove();
        text4.remove();
        layer.draw();
        updateCount(rect4);
        updateAvaliable()
      });

      rect4.on('mouseenter', function () {
        stage.container().style.cursor = 'pointer';
      });

      rect4.on('mouseleave', function () {
        stage.container().style.cursor = 'default';
      });

      var text4 = new Konva.Text({
        x: 305,
        y: 5
      });

      document.getElementById('add943').addEventListener('click', function () {
        updateAvaliable()
        console.log('add 943')
        layer.add(rect4);
        layer.add(text4);
        updateText(rect4, text4);
        updateCount(rect4);
        updateAvaliable()
      });

      // ---------- 2x2 square (72 min) ---------- //
      var rect5 = new Konva.Rect({
        x: 960,
        y: 160,
        width: 8.2,
        height: 8.2,
        fill: 'yellow',
        name: 'rect',
        draggable: true,
        value: 72,
        hitFunc: function (context) {
          context.beginPath();
          context.arc(5, 5, 25, 0, Math.PI * 2, true);
          context.closePath();
          context.fillStrokeShape(this);
        }
      });

      rect5.on('transformstart', function () {
        console.log('transform start');
      });

      rect5.on('dragmove', function () {
        updateText(rect5, text5);
      });
      rect5.on('transform', function () {
        updateText(rect5, text5);
        console.log('transform');
      });

      rect5.on('transformend', function () {
        console.log('transform end');
      });

      rect5.on('dblclick dbltap', function () {
        updateAvaliable()
        rect5.remove();
        text5.remove();
        layer.draw();
        updateCount(rect5);
        updateAvaliable()
      });

      rect5.on('mouseenter', function () {
        stage.container().style.cursor = 'pointer';
      });

      rect5.on('mouseleave', function () {
        stage.container().style.cursor = 'default';
      });

      var text5 = new Konva.Text({
        x: 405,
        y: 5
      });

      document.getElementById('add72').addEventListener('click', function () {
        updateAvaliable()
        console.log('add 72')
        layer.add(rect5);
        layer.add(text5);
        updateText(rect5, text5);
        updateCount(rect5);
        updateAvaliable()
      });

      // ---------- 3 lines (74 min) ---------- //
      var rect6 = new Konva.Rect({
        x: 1160,
        y: 160,
        width: 56.7,
        height: 90.7,
        fill: 'yellow',
        name: 'rect',
        draggable: true,
        value: 74
      });

      rect6.on('transformstart', function () {
        console.log('transform start');
      });

      rect6.on('dragmove', function () {
        updateText(rect6, text6);
      });
      rect6.on('transform', function () {
        updateText(rect6, text6);
        console.log('transform');
      });

      rect6.on('transformend', function () {
        console.log('transform end');
      });

      rect6.on('dblclick dbltap', function () {
        updateAvaliable()
        rect6.remove();
        text6.remove();
        layer.draw();
        updateCount(rect6);
        updateAvaliable()
      });

      rect6.on('mouseenter', function () {
        stage.container().style.cursor = 'pointer';
      });

      rect6.on('mouseleave', function () {
        stage.container().style.cursor = 'default';
      });

      var text6 = new Konva.Text({
        x: 505,
        y: 5
      });

      document.getElementById('add74').addEventListener('click', function () {
        updateAvaliable()
        console.log('add 74')
        layer.add(rect6);
        layer.add(text6);
        updateText(rect6, text6);
        updateCount(rect6);
        updateAvaliable()
      });


      stage.on('click tap', function (e) {
        // if click on empty area - remove all transformers
        if (e.target === stage) {
          stage.find('Transformer').destroy();
          layer.draw();
          return;
        }
        // do nothing if clicked NOT on our rectangles
        if (!e.target.hasName('rect')) {
          return;
        }
        // remove old transformers
        // TODO: we can skip it if current rect is already selected
        stage.find('Transformer').destroy();

        // create new transformer
        var tr = new Konva.Transformer({
          rotationSnaps: [0, 90, 180, 270],
          resizeEnabled: false
        });
        layer.add(tr);
        tr.attachTo(e.target);
        layer.draw();
      });

      var countText = new Konva.Text({
        x: 705,
        y: 5
      });

      layer.add(countText);

      function getCount() {
        var i = 0;
        count = 0;
        for (i = 0; i < layer.children.length; i++) {
          if (layer.children[i].attrs.value) {
            count += layer.children[i].attrs.value
          }
        }
        return count;
      }

      function updateAvaliable() {
        // 143
        if (getCount() + 143 > threshold) {
          document.getElementById("add143").disabled = true;
        } else {
          document.getElementById("add143").disabled = false;
        }

        // 32
        if (getCount() + 32 > threshold) {
          document.getElementById("add32").disabled = true;
        } else {
          document.getElementById("add32").disabled = false;
        }

        // 610
        if (getCount() + 610 > threshold) {
          document.getElementById("add610").disabled = true;
        } else {
          document.getElementById("add610").disabled = false;
        }

        // 943
        if (getCount() + 943 > threshold) {
          document.getElementById("add943").disabled = true;
        } else {
          document.getElementById("add943").disabled = false;
        }

        // 74
        if (getCount() + 74 > threshold) {
          document.getElementById("add74").disabled = true;
        } else {
          document.getElementById("add74").disabled = false;
        }

        // 72
        if (getCount() + 72 > threshold) {
          document.getElementById("add72").disabled = true;
        } else {
          document.getElementById("add72").disabled = false;
        }
      }


      function updateCount(node) {
        var count = [
          'Total time: ' + getCount(),
        ];
        countText.text(count.join(''));
        layer.batchDraw();
      }


      function updateText(node, text) {
        var lines = [
          'x: ' + node.x(),
          'y: ' + node.y(),
          'rotation: ' + node.rotation(),
          'width: ' + node.width(),
          'height: ' + node.height(),
          'scaleX: ' + node.scaleX(),
          'scaleY: ' + node.scaleY()
        ];
        text.text(lines.join('\n'));
        layer.batchDraw();
      }



      document.getElementById('toggle').addEventListener('click', function () {
        layer.toggleHitCanvas();
        getCount();
      });

    </script>
  </body>

</html>