{% extends 'layout.html' %} {% block head %}
<script src="https://cdn.rawgit.com/konvajs/konva/2.4.0/konva.min.js"></script>
<script src="https://unpkg.com/konva@3.2.4/konva.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css"></script>

{% endblock %} {% block body_no %}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-2"></div>
    <div class="col-md-4">
      <form action="" method="GET" name="order">
          <input type="hidden" id="locations" name="locations" value="{}" class="form-control" />
          <input type="hidden" id="numRationals" name="numRationals" value="{{ length }}" class="form-control" />
          {% for item in range(length) %}
          <textarea type="text-area" style="background-color: rgb(240, 240, 240)" class="form-control" name="rational{{ item + 1 }}" id="textarea" placeholder="Rationale for target {{ item + 1 }}:" required>{{ rationals[item] }}</textarea>
          <br>
          {% endfor %}
          <button class="btn btn-primary item pull-right" type="submit" name="action" value="proceed" id="locationSubmit">Submit</button>
          <button class="btn btn-danger item pull-right" type="submit" name="action" value="back" id="locationSubmit2"><i class="fa fa-arrow-circle-left fa-5x"></i> Back</button>
      </form>
    </div>
    <div class="col-md-6">
      <div id="container" style="background: url('https://storage.googleapis.com/geovision-site/task3_small.jpg'); width: 100%; background-repeat: no-repeat;"></div>
    </div>
  </div>
</div>

<script>
  var width = 598;
  var height = 657;

  var stage = new Konva.Stage({
    container: 'container',
    width: width,
    height: height
  });

  var layer = new Konva.Layer();
  stage.add(layer);

  var order = 1;
  var numLocations = {{ length }};


  if ("{{ visited }}" === "True") {
    {% for item in locations.keys() %}
    console.log("{{ item }}")

    {% if locations[item]['value'] == 32 %}
    var x = {{ locations[item]['x'] }};
    var y = {{ locations[item]['y'] }};
    var rot = {{ locations[item]['rotation'] }};
    var id = {{ item }};
    add32(x, y, rot, id);
    layer.draw()
    {% endif %}

    {% if locations[item]['value'] == 143 %}
    var x = {{ locations[item]['x'] }};
    var y = {{ locations[item]['y'] }};
    var rot = {{ locations[item]['rotation'] }};
    var id = {{ item }};
    add143(x, y, rot, id);
    layer.draw()
    {% endif %}

    {% if locations[item]['value'] == 610 %}
    var x = {{ locations[item]['x'] }};
    var y = {{ locations[item]['y'] }};
    var rot = {{ locations[item]['rotation'] }};
    var id = {{ item }};
    add610(x, y, rot, id);
    layer.draw()
    {% endif %}

    {% if locations[item]['value'] == 943 %}
    var x = {{ locations[item]['x'] }};
    var y = {{ locations[item]['y'] }};
    var rot = {{ locations[item]['rotation'] }};
    var id = {{ item }};
    add943(x, y, rot, id);
    layer.draw()
    {% endif %}

    {% if locations[item]['value'] == 74 %}
    var x = {{ locations[item]['x'] }};
    var y = {{ locations[item]['y'] }};
    var rot = {{ locations[item]['rotation'] }};
    var id = {{ item }};
    add74(x, y, rot, id);
    layer.draw()
    {% endif %}

    {% if locations[item]['value'] == 72 %}
    var x = {{ locations[item]['x'] }};
    var y = {{ locations[item]['y'] }};
    var rot = {{ locations[item]['rotation'] }};
    var id = {{ item }};
    add72(x, y, rot, id);
    layer.draw()
    {% endif %}

    {% endfor %}
    }


  // ---------- grid (143 min) ---------- //
  function add143(x, y, rot, id, id) {
    console.log('add 143')
    layer.add(new Konva.Rect({
      x: x,
      y: y,
      width: 90.7, // 24 mm
      height: 90.7, // 24 mm
      rotation: rot,
      fill: 'yellow',
      name: 'rect',
      value: 143,
      numbered: false,
      id: id,
    }));
  }

  // ---------- 1 line (32 min) ---------- //
  function add32(x, y, rot, id) {
    console.log('add 32')
    layer.add(new Konva.Rect({
      x: x,
      y: y,
      width: 4.8,
      height: 90.7,
      rotation: rot,
      fill: 'yellow',
      name: 'rect',
      value: 32,
      numbered: false,
      id: id,
      hitFunc: function (context) {
        context.beginPath();
        context.rect(-15, -10, 4.8 + 30, 90.7 + 20);
        context.closePath();
        context.fillStrokeShape(this);
      }
    }));
  }

  // ---------- 7x7 square (610 min) ---------- //
  function add610(x, y, rot, id) {
    console.log('add 610')
    layer.add(new Konva.Rect({
      x: x,
      y: y,
      width: 26.3,
      height: 26.3,
      rotation: rot,
      fill: 'yellow',
      name: 'rect',
      value: 610,
      numbered: false,
      id: id,
      hitFunc: function (context) {
        context.beginPath();
        context.rect(-10, -10, 26.3 + 20, 26.3 + 20);
        context.closePath();
        context.fillStrokeShape(this);
      }
    }));
  }

  // ---------- 5x15 square (943 min) ---------- //
  function add943(x, y, rot, id) {
    console.log('add 943')
    layer.add(new Konva.Rect({
      x: x,
      y: y,
      width: 19.0,
      height: 56.7,
      rotation: rot,
      fill: 'yellow',
      name: 'rect',
      value: 943,
      numbered: false,
      id: id,
      hitFunc: function (context) {
        context.beginPath();
        context.rect(-10, -10, 19.0 + 20, 56.7 + 20);
        context.closePath();
        context.fillStrokeShape(this);
      }
    }));
  }

  // ---------- 2x2 square (72 min) ---------- //
  function add72(x, y, rot, id) {
    console.log('add 72')
    layer.add(new Konva.Rect({
      x: x,
      y: y,
      width: 8.2,
      height: 8.2,
      rotation: rot,
      fill: 'yellow',
      name: 'rect',
      value: 72,
      numbered: false,
      id: id,
      hitFunc: function (context) {
        context.beginPath();
        context.arc(5, 5, 25, 0, Math.PI * 2, true);
        context.closePath();
        context.fillStrokeShape(this);
      }
    }));
  }

  // ---------- 3 lines (74 min) ---------- //
  function add74(x, y, rot, id) {
    console.log('add 74')
    layer.add(
      new Konva.Rect({
        x: x,
        y: y,
        width: 56.7,
        height: 90.7,
        rotation: rot,
        fill: 'yellow',
        name: 'rect',
        numbered: false,
        value: 74,
        id: id,
      }));
    layer.draw()
  }

  // ---------- layer settings ---------- //
  layer.on('mouseenter', function (e) {
    if (!e.target.hasName('rect') || e.target.attrs.numbered == true) {
      return;
    }
    stage.container().style.cursor = 'pointer';
  });

  layer.on('mouseleave', function () {
    stage.container().style.cursor = 'default';
  });

  stage.on('click tap', function (e) {
    if (!e.target.hasName('rect') || e.target.attrs.numbered == true) {
      return;
    }
    var pos = stage.getPointerPosition();

    if (order <= numLocations && e.target.attrs.numbered == false) {
      e.target.attrs.numbered = true;
      if (e.target.attrs.value == 72) {
        layer.add(new Konva.Circle ({
        x: e.target.attrs.x - 10,
        y: e.target.attrs.y - 10,
        radius: 15,
        fill: 'red',
      }));
      if (order < 10) {
        layer.add(new Konva.Text ({
          x: e.target.attrs.x - 15,
          y: e.target.attrs.y - 18,
          text: order,
          fontSize: 20,
          fill: 'white'
        }));
      } else {
          layer.add(new Konva.Text ({
          x: e.target.attrs.x - 21,
          y: e.target.attrs.y - 18,
          text: order,
          fontSize: 20,
          fill: 'white'
        }));
      }
      } else {
        layer.add(new Konva.Circle ({
        x: e.target.attrs.x,
        y: e.target.attrs.y,
        radius: 15,
        fill: 'red',
        }));

        if (order < 10) {
          layer.add(new Konva.Text ({
            x: e.target.attrs.x - 5,
            y: e.target.attrs.y - 8,
            text: order,
            fontSize: 20,
            fill: 'white'
          }));
        } else {
            layer.add(new Konva.Text ({
            x: e.target.attrs.x - 11,
            y: e.target.attrs.y - 8,
            text: order,
            fontSize: 20,
            fill: 'white'
          }));
        }
      }
      e.target.attrs.order = order;
      layer.draw();
      order = order + 1;
    }
  });

  function checkOrder(e) {
    var children = layer.getChildren(function(node) {
        return node.getClassName() === 'Rect';
      });
    
    for (var i = 0; i < children.length; i++) {
      console.log(children[i].attrs.order);
      console.log(typeof children[i].attrs.order == 'undefined');
      if (typeof children[i].attrs.order == 'undefined') {
        e.preventDefault();
        alert("Please select order");
        window.history.forward(-1);
        return false;
      }
      return true;
    }
  }

  // submit
  document.getElementById("locationSubmit").addEventListener('click', function (e) {
    document.getElementById('locations').value = JSON.stringify(layer.getChildren(function(node) {
        return node.getClassName() === 'Rect';
      }))
    
    checkOrder(e);
  });

  // back
  document.getElementById("locationSubmit2").addEventListener('click', function (e) {
    var elems = document.querySelectorAll('[id=textarea]');
    console.log(elems);
    for (var i=0; i < elems.length; i++){
      elems[i].required = false;
    }
    document.getElementById('locations').value = JSON.stringify(layer.getChildren(function(node) {
        return node.getClassName() === 'Rect';
      }))
  });


  function fitStageIntoParentContainer() {
    var container = document.querySelector('#stage-parent');

    // now we need to fit stage into parent
    var containerWidth = container.offsetWidth;
    // to do this we need to scale the stage
    var scale = containerWidth / stageWidth;

    stage.width(stageWidth * scale);
    stage.height(stageHeight * scale);
    stage.scale({ x: scale, y: scale });
    stage.draw();
  }

  fitStageIntoParentContainer();
  // adapt the stage on any window resize
  window.addEventListener('resize', fitStageIntoParentContainer);

</script>

<script src="https://cdn.jsdelivr.net/npm/interactjs@1.3/dist/interact.min.js"></script>
{% endblock %}